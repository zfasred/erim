<!-- templates/carbon/excel_report.html -->
{% extends 'base.html' %}
{% block title %}Excel Karbon Raporu{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2>üìä Excel Karbon Ayak ƒ∞zi Raporu</h2>
    
    <!-- Firma ve D√∂nem Se√ßimi -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row">
                <div class="col-md-4">
                    <select name="firm_id" class="form-control" onchange="this.form.submit()">
                        <option value="">-- Firma Se√ßin --</option>
                        {% for firm in firms %}
                        <option value="{{ firm.id }}" {% if firm == selected_firm %}selected{% endif %}>
                            {{ firm.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="year" class="form-control" onchange="this.form.submit()">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="month" class="form-control" onchange="this.form.submit()">
                        <option value="1">Ocak</option>
                        <option value="2">≈ûubat</option>
                        <!-- Diƒüer aylar -->
                    </select>
                </div>
            </form>
        </div>
    </div>

    {% if report %}
    
    <!-- √ñZET KAR≈ûILA≈ûTIRMA -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5>üìà TOPLAM KARBON Mƒ∞KTARI</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Sistem Hesaplamasƒ±:</h6>
                    <table class="table table-sm">
                        <tr>
                            <td>KAPSAM 1:</td>
                            <td class="text-end"><strong>{{ report.scope1_total|floatformat:2 }}</strong> tCO2e</td>
                        </tr>
                        <tr>
                            <td>KAPSAM 2:</td>
                            <td class="text-end"><strong>{{ report.scope2_total|floatformat:2 }}</strong> tCO2e</td>
                        </tr>
                        <tr>
                            <td>KAPSAM 3:</td>
                            <td class="text-end"><strong>{{ report.scope3_total|floatformat:2 }}</strong> tCO2e</td>
                        </tr>
                        <tr>
                            <td>KAPSAM 4:</td>
                            <td class="text-end"><strong>{{ report.scope4_total|floatformat:2 }}</strong> tCO2e</td>
                        </tr>
                        <tr class="table-primary">
                            <td><strong>TOPLAM:</strong></td>
                            <td class="text-end"><strong>{{ report.total_co2e|floatformat:2 }}</strong> tCO2e</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Excel Deƒüerleri (Referans):</h6>
                    <table class="table table-sm">
                        <tr>
                            <td>KAPSAM 1:</td>
                            <td class="text-end">18,049.12 tCO2e</td>
                        </tr>
                        <tr>
                            <td>KAPSAM 2:</td>
                            <td class="text-end">6,995.34 tCO2e</td>
                        </tr>
                        <tr>
                            <td>KAPSAM 3:</td>
                            <td class="text-end">206.48 tCO2e</td>
                        </tr>
                        <tr>
                            <td>KAPSAM 4:</td>
                            <td class="text-end">15,354.70 tCO2e</td>
                        </tr>
                        <tr class="table-warning">
                            <td><strong>TOPLAM:</strong></td>
                            <td class="text-end"><strong>40,605.64</strong> tCO2e</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- KAPSAM 1 DETAY -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5>KAPSAM 1: Doƒürudan Sera Gazƒ± Emisyonlarƒ±</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Lokasyon</th>
                        <th>Yakƒ±t T√ºr√º</th>
                        <th>FV (m¬≥)</th>
                        <th>CO2 (ton)</th>
                        <th>CH4 (ton)</th>
                        <th>N2O (ton)</th>
                        <th>CO2e (ton)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in scope1_data %}
                    <tr>
                        <td>{{ item.location }}</td>
                        <td>{{ item.fuel_type.name }}</td>
                        <td>{{ item.consumption_value|floatformat:0 }}</td>
                        <td>{{ item.co2_emission|floatformat:6 }}</td>
                        <td>{{ item.ch4_emission|floatformat:9 }}</td>
                        <td>{{ item.n2o_emission|floatformat:9 }}</td>
                        <td><strong>{{ item.co2e_total|floatformat:2 }}</strong></td>
                    </tr>
                    {% endfor %}
                    <tr class="table-info">
                        <td colspan="6"><strong>TOPLAM KAPSAM 1</strong></td>
                        <td><strong>{{ report.scope1_total|floatformat:2 }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- KAPSAM 2 DETAY -->
    <div class="card mb-3">
        <div class="card-header bg-warning">
            <h5>KAPSAM 2: ƒ∞thal Edilen Enerji</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Tesis</th>
                        <th>FV (kWh)</th>
                        <th>FV (MWh)</th>
                        <th>EF (tCO2/MWh)</th>
                        <th>tCO2e</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in scope2_data %}
                    <tr>
                        <td>{{ item.facility }}</td>
                        <td>{{ item.electricity_kwh|floatformat:0 }}</td>
                        <td>{{ item.electricity_mwh|floatformat:2 }}</td>
                        <td>{{ item.emission_factor|floatformat:3 }}</td>
                        <td><strong>{{ item.co2e_total|floatformat:2 }}</strong></td>
                    </tr>
                    {% endfor %}
                    <tr class="table-info">
                        <td colspan="4"><strong>TOPLAM KAPSAM 2</strong></td>
                        <td><strong>{{ report.scope2_total|floatformat:2 }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- KAPSAM 4 DETAY -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            <h5>KAPSAM 4: Satƒ±n Alƒ±nan √úr√ºnler</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Malzeme</th>
                        <th>Miktar (kg)</th>
                        <th>EF (kgCO2e/kg)</th>
                        <th>tCO2e</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in scope4_data %}
                    <tr>
                        <td>{{ item.material_name }}</td>
                        <td>{{ item.quantity_kg|floatformat:0 }}</td>
                        <td>{{ item.emission_factor|floatformat:2 }}</td>
                        <td><strong>{{ item.co2e_total|floatformat:2 }}</strong></td>
                    </tr>
                    {% endfor %}
                    <tr class="table-info">
                        <td colspan="3"><strong>TOPLAM KAPSAM 4</strong></td>
                        <td><strong>{{ report.scope4_total|floatformat:2 }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- FORM√úL Bƒ∞LGƒ∞LERƒ∞ -->
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h5>üìù Hesaplama Form√ºlleri</h5>
        </div>
        <div class="card-body">
            <p><strong>Kapsam 1:</strong> (FV √ó EF √ó NKD √ó Yoƒüunluk) √ó 10‚Åª‚Åπ</p>
            <p><strong>CO2e:</strong> CO2 + (CH4 √ó 27.9) + (N2O √ó 273)</p>
            <p><strong>Kapsam 2:</strong> MWh √ó 0.442</p>
            <p><strong>Kapsam 4:</strong> Miktar(kg) √ó EF / 1000</p>
            <div class="alert alert-info mt-3">
                <strong>GWP Deƒüerleri:</strong> CH4 = 27.9, N2O = 273 (IPCC AR5)
            </div>
        </div>
    </div>

    {% else %}
    <div class="alert alert-warning">
        L√ºtfen firma ve d√∂nem se√ßimi yapƒ±n. Veri yoksa √∂nce ≈üu komutu √ßalƒ±≈ütƒ±rƒ±n:
        <code>python manage.py load_excel_data</code>
    </div>
    {% endif %}
</div>

<style>
    .table-bordered th {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    .card-header h5 {
        margin: 0;
    }
</style>
{% endblock %}