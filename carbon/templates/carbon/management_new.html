<!-- templates/carbon/management_new.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Karbon Yönetim{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">
        <i class="fas fa-cog"></i> Karbon Emisyon Faktörleri Yönetimi
    </h2>

    <!-- YENİ KALEM EKLEME BÖLÜMÜ -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-plus"></i> Yeni Kalem Ekle
            </h5>
        </div>
        <div class="card-body">
            <form id="addItemForm">
                {% csrf_token %}
                <div class="row">
                    <!-- Kapsam Seçimi -->
                    <div class="col-md-2">
                        <select name="category" id="addCategory" class="form-control" required>
                            <option value="">Kapsam Seç</option>
                            {% for scope in scopes %}
                            <option value="{{ scope.value }}">{{ scope.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Alt Kapsam -->
                    <div class="col-md-2">
                        <select name="subcategory" id="addSubcategory" class="form-control" required disabled>
                            <option value="">Alt Kapsam</option>
                        </select>
                    </div>
                    
                    <!-- Kalem Adı -->
                    <div class="col-md-2">
                        <input type="text" name="name" class="form-control" placeholder="Kalem Adı" required>
                    </div>
                    
                    <!-- Değer -->
                    <div class="col-md-1">
                        <input type="number" step="0.000001" name="value" class="form-control" placeholder="Değer" required>
                    </div>
                    
                    <!-- Birim -->
                    <div class="col-md-1">
                        <select name="unit" class="form-control" required>
                            <option value="">Birim</option>
                            {% for unit in units %}
                            <option value="{{ unit }}">{{ unit }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Başlangıç Tarihi -->
                    <div class="col-md-1">
                        <input type="date" name="valid_from" class="form-control" required title="Başlangıç">
                    </div>
                    
                    <!-- Bitiş Tarihi -->
                    <div class="col-md-1">
                        <input type="date" name="valid_to" class="form-control" title="Bitiş (Opsiyonel)">
                    </div>
                    
                    <!-- Kaynak -->
                    <div class="col-md-1">
                        <input type="text" name="source" class="form-control" placeholder="Kaynak">
                    </div>
                    
                    <!-- Ekle Butonu -->
                    <div class="col-md-1">
                        <button type="submit" class="btn btn-success btn-block">
                            <i class="fas fa-plus"></i> Ekle
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- MEVCUT KALEMLER BÖLÜMÜ -->
    <div class="card">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> Mevcut Kalemler
            </h5>
        </div>
        <div class="card-body">
            <!-- Filtreleme -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <label>Kapsam Seçin:</label>
                    <select id="filterScope" class="form-control">
                        <option value="">-- Kapsam Seçin --</option>
                        {% for scope in scopes %}
                        <option value="{{ scope.value }}">{{ scope.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label>Alt Kapsam Seçin:</label>
                    <select id="filterSubcategory" class="form-control" disabled>
                        <option value="">-- Alt Kapsam Seçin --</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>&nbsp;</label>
                    <button id="filterBtn" class="btn btn-info btn-block" disabled>
                        <i class="fas fa-search"></i> Listele
                    </button>
                </div>
            </div>

            <!-- Liste Tablosu -->
            <div id="itemsList">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    Lütfen önce kapsam ve alt kapsam seçimi yapın.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Güncelleme Modal -->
<div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Kalem Güncelle</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="updateForm">
                    {% csrf_token %}
                    <input type="hidden" name="item_id" id="updateItemId">
                    
                    <div class="form-group">
                        <label>Kalem Adı:</label>
                        <input type="text" name="name" id="updateName" class="form-control" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Değer:</label>
                                <input type="number" step="0.000001" name="value" id="updateValue" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Birim:</label>
                                <select name="unit" id="updateUnit" class="form-control" required>
                                    {% for unit in units %}
                                    <option value="{{ unit }}">{{ unit }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Aktif:</label>
                                <div class="form-check">
                                    <input type="checkbox" name="is_active" id="updateActive" class="form-check-input">
                                    <label class="form-check-label" for="updateActive">Aktif</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Başlangıç Tarihi:</label>
                                <input type="date" name="valid_from" id="updateValidFrom" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Bitiş Tarihi:</label>
                                <input type="date" name="valid_to" id="updateValidTo" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Kaynak:</label>
                                <input type="text" name="source" id="updateSource" class="form-control">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="updateBtn">Güncelle</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    const csrfToken = $('[name=csrfmiddlewaretoken]').val();
    
    // Yeni kalem eklerken kapsam değişimi
    $('#addCategory').change(function() {
        const scope = $(this).val();
        if (scope) {
            $.ajax({
                url: window.location.href,
                type: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                data: {
                    action: 'get_subcategories',
                    scope: scope,
                    csrfmiddlewaretoken: csrfToken
                },
                success: function(response) {
                    $('#addSubcategory').empty().append('<option value="">Alt Kapsam</option>');
                    response.subcategories.forEach(function(sub) {
                        $('#addSubcategory').append(`<option value="${sub.value}">${sub.label}</option>`);
                    });
                    $('#addSubcategory').prop('disabled', false);
                }
            });
        } else {
            $('#addSubcategory').empty().append('<option value="">Alt Kapsam</option>').prop('disabled', true);
        }
    });
    
    // Filtreleme kapsam değişimi
    $('#filterScope').change(function() {
        const scope = $(this).val();
        if (scope) {
            $.ajax({
                url: window.location.href,
                type: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                data: {
                    action: 'get_subcategories',
                    scope: scope,
                    csrfmiddlewaretoken: csrfToken
                },
                success: function(response) {
                    $('#filterSubcategory').empty().append('<option value="">-- Alt Kapsam Seçin --</option>');
                    response.subcategories.forEach(function(sub) {
                        $('#filterSubcategory').append(`<option value="${sub.value}">${sub.label}</option>`);
                    });
                    $('#filterSubcategory').prop('disabled', false);
                    $('#filterBtn').prop('disabled', false);
                }
            });
        } else {
            $('#filterSubcategory').empty().append('<option value="">-- Alt Kapsam Seçin --</option>').prop('disabled', true);
            $('#filterBtn').prop('disabled', true);
        }
    });
    
    // Yeni kalem ekle
    $('#addItemForm').submit(function(e) {
        e.preventDefault();
        const formData = $(this).serialize() + '&action=add_item&is_active=true';
        
        $.ajax({
            url: window.location.href,
            type: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            data: formData,
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    $('#addItemForm')[0].reset();
                    $('#addSubcategory').empty().append('<option value="">Alt Kapsam</option>').prop('disabled', true);
                    
                    // Listeyi yenile
                    if ($('#filterSubcategory').val()) {
                        $('#filterBtn').click();
                    }
                } else {
                    alert('Hata: ' + response.message);
                }
            }
        });
    });
    
    // Listeyi getir
    $('#filterBtn').click(function() {
        const scope = $('#filterScope').val();
        const subcategory = $('#filterSubcategory').val();
        
        if (!subcategory) {
            alert('Lütfen alt kapsam seçin!');
            return;
        }
        
        $.ajax({
            url: window.location.href,
            type: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            data: {
                action: 'get_items',
                scope: scope,
                subcategory: subcategory,
                csrfmiddlewaretoken: csrfToken
            },
            success: function(response) {
                if (response.items.length > 0) {
                    let tableHtml = `
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Kalem Adı</th>
                                    <th>Değer</th>
                                    <th>Birim</th>
                                    <th>Başlangıç</th>
                                    <th>Bitiş</th>
                                    <th>Aktif</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    response.items.forEach(function(item) {
                        const activeCheck = item.is_active ? 'checked' : '';
                        const activeClass = item.is_active ? '' : 'table-secondary';
                        
                        tableHtml += `
                            <tr class="${activeClass}">
                                <td>${item.name}</td>
                                <td>${item.value}</td>
                                <td>${item.unit}</td>
                                <td>${item.valid_from}</td>
                                <td>${item.valid_to || '-'}</td>
                                <td>
                                    <input type="checkbox" ${activeCheck} disabled>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-warning updateBtn" data-item='${JSON.stringify(item)}'>
                                        <i class="fas fa-edit"></i> Güncelle
                                    </button>
                                    <button class="btn btn-sm btn-danger deleteBtn" data-id="${item.id}">
                                        <i class="fas fa-trash"></i> Sil
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableHtml += '</tbody></table>';
                    $('#itemsList').html(tableHtml);
                } else {
                    $('#itemsList').html('<div class="alert alert-warning">Bu kriterlere uygun kalem bulunamadı.</div>');
                }
            }
        });
    });
    
    // Güncelleme modalını aç
    $(document).on('click', '.updateBtn', function() {
        const item = $(this).data('item');
        $('#updateItemId').val(item.id);
        $('#updateName').val(item.name);
        $('#updateValue').val(item.value);
        $('#updateUnit').val(item.unit);
        $('#updateValidFrom').val(item.valid_from);
        $('#updateValidTo').val(item.valid_to);
        $('#updateSource').val(item.source || '');
        $('#updateActive').prop('checked', item.is_active);
        
        $('#updateModal').modal('show');
    });
    
    // Güncelleme işlemi
    $('#updateBtn').click(function() {
        const formData = $('#updateForm').serialize() + '&action=update_item&is_active=' + $('#updateActive').is(':checked');
        
        $.ajax({
            url: window.location.href,
            type: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            data: formData,
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    $('#updateModal').modal('hide');
                    $('#filterBtn').click(); // Listeyi yenile
                } else {
                    alert('Hata: ' + response.message);
                }
            }
        });
    });
    
    // Silme işlemi
    $(document).on('click', '.deleteBtn', function() {
        if (!confirm('Bu kalemi silmek istediğinizden emin misiniz?')) {
            return;
        }
        
        const itemId = $(this).data('id');
        
        $.ajax({
            url: window.location.href,
            type: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            data: {
                action: 'delete_item',
                item_id: itemId,
                csrfmiddlewaretoken: csrfToken
            },
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    $('#filterBtn').click(); // Listeyi yenile
                } else {
                    alert('Hata: ' + response.message);
                }
            }
        });
    });
});
</script>

<style>
    .form-control {
        font-size: 14px;
    }
    .table-secondary {
        opacity: 0.7;
    }
    .btn-sm {
        padding: 2px 8px;
        font-size: 12px;
    }
</style>
{% endblock %}