{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">Karbon Rapor</h2>
    
    <!-- Filtre Formu -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="report-filter-form">
                <div class="row">
                    <div class="col-md-4">
                        <label>Firma Seçimi:</label>
                        <select id="firm-select" class="form-control" required>
                            <option value="">-- Firma Seçin --</option>
                            {% for firm in user_firms %}
                            <option value="{{ firm.id }}">{{ firm.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Başlangıç Tarihi:</label>
                        <input type="date" id="start-date" class="form-control" 
                               value="{{ today|date:'Y-m-01' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label>Bitiş Tarihi:</label>
                        <input type="date" id="end-date" class="form-control" 
                               value="{{ today|date:'Y-m-d' }}" required>
                    </div>
                    <div class="col-md-2">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-search"></i> Rapor Oluştur
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Rapor Alanı -->
    <div id="report-container" style="display:none;">
        <!-- Özet Kartlar -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h5 class="card-title">Kapsam 1</h5>
                        <h3 id="scope1-total">0</h3>
                        <small>tCO₂e</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">Kapsam 2</h5>
                        <h3 id="scope2-total">0</h3>
                        <small>tCO₂e</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h5 class="card-title">Kapsam 3</h5>
                        <h3 id="scope3-total">0</h3>
                        <small>tCO₂e</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h5 class="card-title">Kapsam 4</h5>
                        <h3 id="scope4-total">0</h3>
                        <small>tCO₂e</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tablo Alanı -->
        <div id="tables-container">
            <!-- JavaScript ile doldurulacak -->
        </div>
    </div>
</div>

<script>
function createTables(scopeDetails) {
    const container = document.getElementById('tables-container');
    container.innerHTML = '';
    
    // Her kapsam için tablo oluştur
    for (let scope in scopeDetails) {
        const scopeNumber = scope.replace('scope_', '');
        const scopeData = scopeDetails[scope];
        
        // Kapsam başlığı
        const scopeTitle = document.createElement('h4');
        scopeTitle.className = 'mt-4 mb-3';
        scopeTitle.textContent = `KAPSAM ${scopeNumber}`;
        container.appendChild(scopeTitle);
        
        // Tablo
        const table = document.createElement('table');
        table.className = 'table table-bordered table-striped';
        
        let tableHTML = `
            <thead class="thead-dark">
                <tr>
                    <th>Alt Kapsam</th>
                    <th>İsim</th>
                    <th>Tarih</th>
                    <th>Değer</th>
                    <th>Birim</th>
                    <th>tCO₂e</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        let scopeTotal = 0;
        
        // Alt kapsamları döngüle
        for (let subscope in scopeData) {
            const subscopeData = scopeData[subscope];
            
            subscopeData.items.forEach(item => {
                // Veri detaylarını parse et
                let name = item.data.fuel_name || item.data.name || item.data.facility_name || '-';
                let value = item.data.consumption || item.data.amount || '-';
                let unit = getUnit(subscope); // Birim fonksiyonu
                
                tableHTML += `
                    <tr>
                        <td>${subscope} - ${subscopeData.name}</td>
                        <td>${name}</td>
                        <td>${item.date}</td>
                        <td>${value}</td>
                        <td>${unit}</td>
                        <td class="text-right">${item.co2e.toFixed(4)}</td>
                    </tr>
                `;
                scopeTotal += item.co2e;
            });
        }
        
        // Toplam satırı
        tableHTML += `
            <tr class="font-weight-bold bg-light">
                <td colspan="5" class="text-right">KAPSAM ${scopeNumber} TOPLAM:</td>
                <td class="text-right">${scopeTotal.toFixed(4)}</td>
            </tr>
        `;
        
        tableHTML += '</tbody>';
        table.innerHTML = tableHTML;
        container.appendChild(table);
    }
}

// Birim belirleme fonksiyonu
function getUnit(subscope) {
    const units = {
        '1.1': 'm³',
        '1.2': 'lt',
        '1.3': 'kg',
        '1.4': 'adet',
        '1.5': 'm²',
        '2.1': 'kWh',
        '3.1': 'lt',
        '3.2': 'lt',
        '3.3': 'lt',
        '3.4': 'lt',
        '3.5': 'adet',
        '4.1': 'kg',
        '4.2': 'kg',
        '4.3': 'kg'
    };
    return units[subscope] || '-';
}
document.getElementById('report-filter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const firmId = document.getElementById('firm-select').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!firmId) {
        alert('Lütfen firma seçin!');
        return;
    }
    
    // Verileri çek
    fetch(`/carbon/api/report-data/?firm=${firmId}&start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            // Rapor alanını göster
            document.getElementById('report-container').style.display = 'block';
            
            // Özet kartları güncelle
            document.getElementById('scope1-total').textContent = 
                (data.scope_totals.scope_1 || 0).toFixed(2);
            document.getElementById('scope2-total').textContent = 
                (data.scope_totals.scope_2 || 0).toFixed(2);
            document.getElementById('scope3-total').textContent = 
                (data.scope_totals.scope_3 || 0).toFixed(2);
            document.getElementById('scope4-total').textContent = 
                (data.scope_totals.scope_4 || 0).toFixed(2);
            
            // Tabloları oluştur (sonraki adımda)
            //console.log('Detay veriler:', data.scope_details);
            createTables(data.scope_details);
        })
        .catch(error => {
            alert('Veri çekme hatası: ' + error);
        });
});
</script>
{% endblock %}