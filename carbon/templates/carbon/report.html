<!-- carbon/templates/carbon/report.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">Karbon Rapor</h2>
    
    <!-- Filtre Formu -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="report-filter-form">
                <div class="row">
                    <div class="col-md-4">
                        <label>Firma Se√ßimi:</label>
                        <select id="firm-select" class="form-control" required>
                            <option value="">-- Firma Se√ßin --</option>
                            {% for firm in user_firms %}
                            <option value="{{ firm.id }}">{{ firm.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Ba≈ülangƒ±√ß Tarihi:</label>
                        <input type="date" id="start-date" class="form-control" 
                               value="{{ today|date:'Y-m-01' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label>Biti≈ü Tarihi:</label>
                        <input type="date" id="end-date" class="form-control" 
                               value="{{ today|date:'Y-m-d' }}" required>
                    </div>
                    <div class="col-md-2">
                        <label>&nbsp;</label>
                        <div style="display: flex; gap: 5px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                <i class="fas fa-search"></i> Rapor Olu≈ütur
                            </button>
                            <select id="reportType" class="form-control" style="width: auto;">
                                <option value="on-rapor">√ñn Rapor</option>
                                <option value="sunulacak-rapor">Sunulacak Rapor</option>
                                <option value="yonetici-ozeti">Y√∂netici √ñzeti</option>
                            </select>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MEVCUT Rapor Alanƒ± (√ñzet rapor i√ßin) -->
    <div id="report-container" style="display:none;">
        <!-- √ñzet Kartlar -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h5 class="card-title">Kapsam 1</h5>
                        <h3 id="scope1-total">0</h3>
                        <small>tCO‚ÇÇe</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">Kapsam 2</h5>
                        <h3 id="scope2-total">0</h3>
                        <small>tCO‚ÇÇe</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h5 class="card-title">Kapsam 3</h5>
                        <h3 id="scope3-total">0</h3>
                        <small>tCO‚ÇÇe</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h5 class="card-title">Kapsam 4</h5>
                        <h3 id="scope4-total">0</h3>
                        <small>tCO‚ÇÇe</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tablo Alanƒ± -->
        <div id="tables-container">
            <!-- JavaScript ile doldurulacak -->
        </div>
    </div>
    
    <!-- YENƒ∞: Word Edit√∂r Alanƒ± (Detaylƒ± rapor i√ßin) -->
    <div id="word-editor-container" style="display:none;">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">üìù Detaylƒ± Rapor Edit√∂r√º</h5>
            </div>
            <div class="card-body">
                <!-- Toolbar i√ßin div -->
                <div id="toolbar"></div>
                
                <!-- Edit√∂r alanƒ± -->
                <div id="editor" style="min-height: 500px; background: white; border: 1px solid #ccc;">
                    <!-- ƒ∞√ßerik buraya gelecek -->
                </div>
                
                <!-- Export butonlarƒ± -->
                <div style="margin-top: 20px;">
                    <button onclick="exportToPDF()" class="btn btn-danger">
                        <i class="fas fa-file-pdf"></i> PDF ƒ∞ndir
                    </button>
                    <button onclick="exportToWord()" class="btn btn-info">
                        <i class="fas fa-file-word"></i> Word ƒ∞ndir
                    </button>
                    <button onclick="closeWordEditor()" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Kapat
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Word Edit√∂r (ba≈ülangƒ±√ßta gizli) -->
    <div id="wordEditor" style="display: none; margin-top: 20px;">
        <div class="card">
            <div class="card-header">
                <h5>üìù Detaylƒ± Rapor Edit√∂r√º</h5>
            </div>
            <div class="card-body">
                <div id="editor" style="min-height: 500px; background: white; padding: 20px; border: 1px solid #ddd;">
                    <!-- ƒ∞√ßerik buraya gelecek -->
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="window.print()" class="btn btn-danger">PDF ƒ∞ndir</button>
                    <button onclick="exportWord()" class="btn btn-info">Word ƒ∞ndir</button>
                    <button onclick="closeWordEditor()" class="btn btn-secondary">Kapat</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Quill Edit√∂r i√ßin CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
// Quill edit√∂r deƒüi≈ükeni
let quill = null;

// MEVCUT createTables fonksiyonunuz aynen kalƒ±yor
function createTables(scopeDetails) {
    const container = document.getElementById('tables-container');
    container.innerHTML = '';
    
    // Her kapsam i√ßin tablo olu≈ütur
    for (let scope in scopeDetails) {
        const scopeNumber = scope.replace('scope_', '');
        const scopeData = scopeDetails[scope];
        
        // Kapsam ba≈ülƒ±ƒüƒ±
        const scopeTitle = document.createElement('h4');
        scopeTitle.className = 'mt-4 mb-3';
        scopeTitle.textContent = `KAPSAM ${scopeNumber}`;
        container.appendChild(scopeTitle);
        
        // Tablo
        const table = document.createElement('table');
        table.className = 'table table-bordered table-striped';
        
        let tableHTML = `
            <thead class="thead-dark">
                <tr>
                    <th>Alt Kapsam</th>
                    <th>ƒ∞sim</th>
                    <th>Tarih</th>
                    <th>Deƒüer</th>
                    <th>Birim</th>
                    <th>tCO‚ÇÇe</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        let scopeTotal = 0;
        
        // Alt kapsamlarƒ± d√∂ng√ºle
        for (let subscope in scopeData) {
            const subscopeData = scopeData[subscope];
            
            subscopeData.items.forEach(item => {
                // Veri detaylarƒ±nƒ± parse et
                let name = item.data.fuel_name || item.data.name || item.data.facility_name || item.data.coefficient_set || '-';
                let value = item.data.consumption || item.data.amount || '-';
                let unit = getUnit(subscope);
                
                tableHTML += `
                    <tr>
                        <td>${subscope} - ${subscopeData.name}</td>
                        <td>${name}</td>
                        <td>${item.date}</td>
                        <td>${value}</td>
                        <td>${unit}</td>
                        <td class="text-right">${item.co2e.toFixed(4)}</td>
                    </tr>
                `;
                scopeTotal += item.co2e;
            });
        }
        
        // Toplam satƒ±rƒ±
        tableHTML += `
            <tr class="font-weight-bold bg-light">
                <td colspan="5" class="text-right">KAPSAM ${scopeNumber} TOPLAM:</td>
                <td class="text-right">${scopeTotal.toFixed(4)}</td>
            </tr>
        `;
        
        tableHTML += '</tbody>';
        table.innerHTML = tableHTML;
        container.appendChild(table);
    }
}

// Birim belirleme fonksiyonu - MEVCUT AYNEN KALIYOR
function getUnit(subscope) {
    const units = {
        '1.1': 'm¬≥',
        '1.2': 'lt',
        '1.3': 'kg',
        '1.4': 'adet',
        '1.5': 'm¬≤',
        '2.1': 'kWh',
        '3.1': 'lt',
        '3.2': 'lt',
        '3.3': 'lt',
        '3.4': 'lt',
        '3.5': 'adet',
        '4.1': 'kg',
        '4.2': 'kg',
        '4.3': 'kg'
    };
    return units[subscope] || '-';
}

document.getElementById('report-filter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const firmId = document.getElementById('firm-select').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const reportType = document.getElementById('reportType').value;  // YENƒ∞
    
    if (!firmId) {
        alert('L√ºtfen firma se√ßin!');
        return;
    }
    
    // YENƒ∞: Rapor tipine g√∂re kontrol
    if (reportType === 'sunulacak-rapor') {
        alert('Sunulacak Rapor √∂zelliƒüi bir sonraki a≈üamada eklenecek.');
        return;
    }
    
    if (reportType === 'yonetici-ozeti') {
        alert('Y√∂netici √ñzeti √∂zelliƒüi bir sonraki a≈üamada eklenecek.');
        return;
    }
    
    // √ñn Rapor se√ßili ise MEVCUT Sƒ∞STEM AYNEN √áALI≈ûIYOR
    fetch(`/carbon/api/report-data/?firm=${firmId}&start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            // Rapor alanƒ±nƒ± g√∂ster
            document.getElementById('report-container').style.display = 'block';
            
            // √ñzet kartlarƒ± g√ºncelle
            document.getElementById('scope1-total').textContent = 
                (data.scope_totals.scope_1 || 0).toFixed(2);
            document.getElementById('scope2-total').textContent = 
                (data.scope_totals.scope_2 || 0).toFixed(2);
            document.getElementById('scope3-total').textContent = 
                (data.scope_totals.scope_3 || 0).toFixed(2);
            document.getElementById('scope4-total').textContent = 
                (data.scope_totals.scope_4 || 0).toFixed(2);
            
            // Tablolarƒ± olu≈ütur
            createTables(data.scope_details);
        })
        .catch(error => {
            alert('Veri √ßekme hatasƒ±: ' + error);
            console.error('Hata detayƒ±:', error);
        });
});


function addWordEditor() {
    // Quill ba≈ülat
    quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['clean']
            ]
        }
    });
}

function fillWordEditor(data, firmId, startDate, endDate) {
    const firmName = document.querySelector(`#firm-select option[value="${firmId}"]`).text;
    const total = (
        (data.scope_totals.scope_1 || 0) + 
        (data.scope_totals.scope_2 || 0) + 
        (data.scope_totals.scope_3 || 0) + 
        (data.scope_totals.scope_4 || 0)
    ).toFixed(2);
    
    // GER√áEK VERƒ∞LERLE rapor i√ßeriƒüi
    const content = `
        <h1>KARBON AYAK ƒ∞Zƒ∞ RAPORU</h1>
        <p><strong>Firma:</strong> ${firmName}</p>
        <p><strong>D√∂nem:</strong> ${startDate} - ${endDate}</p>
        <hr>
        
        <h2>1. √ñZET</h2>
        <p>Toplam Emisyon: <strong>${total} tCO‚ÇÇe</strong></p>
        
        <h2>2. KAPSAM BAZLI DAƒûILIM</h2>
        <p>Kapsam 1: ${(data.scope_totals.scope_1 || 0).toFixed(2)} tCO‚ÇÇe</p>
        <p>Kapsam 2: ${(data.scope_totals.scope_2 || 0).toFixed(2)} tCO‚ÇÇe</p>
        <p>Kapsam 3: ${(data.scope_totals.scope_3 || 0).toFixed(2)} tCO‚ÇÇe</p>
        <p>Kapsam 4: ${(data.scope_totals.scope_4 || 0).toFixed(2)} tCO‚ÇÇe</p>
    `;
    
    if (quill) {
        quill.clipboard.dangerouslyPasteHTML(content);
    }
}

function closeWordEditor() {
    document.getElementById('wordEditor').style.display = 'none';
    document.getElementById('report-container').style.display = 'block';
}

function exportWord() {
    const content = quill.root.innerHTML;
    const blob = new Blob([content], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Karbon_Raporu_${new Date().toISOString().split('T')[0]}.doc`;
    a.click();
}


// MEVCUT fonksiyonunuz (isim deƒüi≈ütirdik sadece)
function generateExistingReport(firmId, startDate, endDate) {
    // MEVCUT AJAX KODUNUZ AYNEN
    fetch(`/carbon/api/report-data/?firm=${firmId}&start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            // Rapor alanƒ±nƒ± g√∂ster
            document.getElementById('report-container').style.display = 'block';
            
            // √ñzet kartlarƒ± g√ºncelle - MEVCUT KODUNUZ
            document.getElementById('scope1-total').textContent = 
                (data.scope_totals.scope_1 || 0).toFixed(2);
            document.getElementById('scope2-total').textContent = 
                (data.scope_totals.scope_2 || 0).toFixed(2);
            document.getElementById('scope3-total').textContent = 
                (data.scope_totals.scope_3 || 0).toFixed(2);
            document.getElementById('scope4-total').textContent = 
                (data.scope_totals.scope_4 || 0).toFixed(2);
            
            // Tablolarƒ± olu≈ütur - MEVCUT FONKSƒ∞YONUNUZ
            createTables(data.scope_details);
        })
        .catch(error => {
            alert('Veri √ßekme hatasƒ±: ' + error);
        });
}

// YENƒ∞ - Detaylƒ± rapor (GER√áEK verilerle)
function generateDetailedReport(firmId, startDate, endDate) {
    // GER√áEK verileri √ßek
    fetch(`/carbon/api/report-data/?firm=${firmId}&start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            // Word edit√∂r alanƒ±nƒ± ekleyelim (hen√ºz yoksa)
            if (!document.getElementById('wordEditor')) {
                addWordEditor();
            }
            
            // Mevcut tablolarƒ± gizle
            document.getElementById('report-container').style.display = 'none';
            
            // Word edit√∂r√º g√∂ster
            document.getElementById('wordEditor').style.display = 'block';
            
            // GER√áEK VERƒ∞LERLE doldur
            fillWordEditor(data, firmId, startDate, endDate);
        })
        .catch(error => {
            alert('Veri √ßekme hatasƒ±: ' + error);
        });
}


// MEVCUT √∂zet rapor fonksiyonu
function generateSummaryReport() {
    const firmId = document.getElementById('firm-select').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!firmId) {
        alert('L√ºtfen firma se√ßin!');
        return;
    }
    
    // MEVCUT AJAX kodunuz aynen
    fetch(`/carbon/api/report-data/?firm=${firmId}&start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            // Word edit√∂r√º gizle, rapor alanƒ±nƒ± g√∂ster
            document.getElementById('word-editor-container').style.display = 'none';
            document.getElementById('report-container').style.display = 'block';
            
            // √ñzet kartlarƒ± g√ºncelle
            document.getElementById('scope1-total').textContent = 
                (data.scope_totals.scope_1 || 0).toFixed(2);
            document.getElementById('scope2-total').textContent = 
                (data.scope_totals.scope_2 || 0).toFixed(2);
            document.getElementById('scope3-total').textContent = 
                (data.scope_totals.scope_3 || 0).toFixed(2);
            document.getElementById('scope4-total').textContent = 
                (data.scope_totals.scope_4 || 0).toFixed(2);
            
            // Tablolarƒ± olu≈ütur
            createTables(data.scope_details);
        })
        .catch(error => {
            alert('Veri √ßekme hatasƒ±: ' + error);
        });
}

// YENƒ∞ detaylƒ± rapor fonksiyonu
function generateDetailedReport() {
    const firmId = document.getElementById('firm-select').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!firmId) {
        alert('L√ºtfen firma se√ßin!');
        return;
    }
    
    // √ñnce verileri √ßek
    fetch(`/carbon/api/report-data/?firm=${firmId}&start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            // √ñzet raporu gizle, word edit√∂r√º g√∂ster
            document.getElementById('report-container').style.display = 'none';
            document.getElementById('word-editor-container').style.display = 'block';
            
            // Quill edit√∂r√º ba≈ülat (hen√ºz ba≈ülatƒ±lmamƒ±≈üsa)
            if (!quill) {
                quill = new Quill('#editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: '#toolbar'
                    }
                });
                
                // Toolbar √∂zelle≈ütir
                const toolbarOptions = [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    ['clean']
                ];
                
                quill.getModule('toolbar').addHandler('header', function(value) {
                    if (value) {
                        quill.format('header', value);
                    }
                });
            }
            
            // Rapor i√ßeriƒüini olu≈ütur
            const reportContent = `
                <h1 style="text-align: center;">KARBON AYAK ƒ∞Zƒ∞ RAPORU</h1>
                <p style="text-align: center;"><strong>Firma:</strong> ${document.getElementById('firm-select').options[document.getElementById('firm-select').selectedIndex].text}</p>
                <p style="text-align: center;"><strong>D√∂nem:</strong> ${startDate} - ${endDate}</p>
                <br>
                
                <h2>1. Y√ñNETƒ∞Cƒ∞ √ñZETƒ∞</h2>
                <p>Bu rapor, firmanƒ±zƒ±n belirtilen d√∂nemdeki karbon ayak izi hesaplamalarƒ±nƒ± i√ßermektedir.</p>
                <p><strong>Toplam Emisyon:</strong> ${((data.scope_totals.scope_1 || 0) + (data.scope_totals.scope_2 || 0) + (data.scope_totals.scope_3 || 0) + (data.scope_totals.scope_4 || 0)).toFixed(2)} tCO‚ÇÇe</p>
                <br>
                
                <h2>2. KAPSAM BAZLI EMƒ∞SYONLAR</h2>
                <table border="1" style="width: 100%; border-collapse: collapse;">
                    <tr style="background-color: #f2f2f2;">
                        <th style="padding: 8px;">Kapsam</th>
                        <th style="padding: 8px;">Emisyon (tCO‚ÇÇe)</th>
                        <th style="padding: 8px;">Oran (%)</th>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Kapsam 1 - Doƒürudan Emisyonlar</td>
                        <td style="padding: 8px;">${(data.scope_totals.scope_1 || 0).toFixed(2)}</td>
                        <td style="padding: 8px;">${(((data.scope_totals.scope_1 || 0) / ((data.scope_totals.scope_1 || 0) + (data.scope_totals.scope_2 || 0) + (data.scope_totals.scope_3 || 0) + (data.scope_totals.scope_4 || 0))) * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Kapsam 2 - Dolaylƒ± Emisyonlar</td>
                        <td style="padding: 8px;">${(data.scope_totals.scope_2 || 0).toFixed(2)}</td>
                        <td style="padding: 8px;">${(((data.scope_totals.scope_2 || 0) / ((data.scope_totals.scope_1 || 0) + (data.scope_totals.scope_2 || 0) + (data.scope_totals.scope_3 || 0) + (data.scope_totals.scope_4 || 0))) * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Kapsam 3 - Diƒüer Dolaylƒ±</td>
                        <td style="padding: 8px;">${(data.scope_totals.scope_3 || 0).toFixed(2)}</td>
                        <td style="padding: 8px;">${(((data.scope_totals.scope_3 || 0) / ((data.scope_totals.scope_1 || 0) + (data.scope_totals.scope_2 || 0) + (data.scope_totals.scope_3 || 0) + (data.scope_totals.scope_4 || 0))) * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Kapsam 4 - Tedarik Zinciri</td>
                        <td style="padding: 8px;">${(data.scope_totals.scope_4 || 0).toFixed(2)}</td>
                        <td style="padding: 8px;">${(((data.scope_totals.scope_4 || 0) / ((data.scope_totals.scope_1 || 0) + (data.scope_totals.scope_2 || 0) + (data.scope_totals.scope_3 || 0) + (data.scope_totals.scope_4 || 0))) * 100).toFixed(1)}%</td>
                    </tr>
                </table>
                <br>
                
                <h2>3. AZALTIM √ñNERƒ∞LERƒ∞</h2>
                <ul>
                    <li>Enerji verimliliƒüi projelerinin uygulanmasƒ±</li>
                    <li>Yenilenebilir enerji kaynaklarƒ±na ge√ßi≈ü</li>
                    <li>Ara√ß filosunun elektrifikasyonu</li>
                    <li>Tedarik zincirinde yerel kaynak kullanƒ±mƒ±nƒ±n artƒ±rƒ±lmasƒ±</li>
                </ul>
                <br>
                
                <h2>4. SONU√á</h2>
                <p>Raporlama d√∂neminde toplam <strong>${((data.scope_totals.scope_1 || 0) + (data.scope_totals.scope_2 || 0) + (data.scope_totals.scope_3 || 0) + (data.scope_totals.scope_4 || 0)).toFixed(2)} tCO‚ÇÇe</strong> karbon emisyonu hesaplanmƒ±≈ütƒ±r.</p>
            `;
            
            // ƒ∞√ßeriƒüi edit√∂re yerle≈ütir
            quill.clipboard.dangerouslyPasteHTML(reportContent);
        })
        .catch(error => {
            alert('Veri √ßekme hatasƒ±: ' + error);
        });
}

// Word edit√∂r√º kapatma
function closeWordEditor() {
    document.getElementById('word-editor-container').style.display = 'none';
}

// PDF Export
function exportToPDF() {
    window.print(); // Basit √ß√∂z√ºm
}

// Word Export
function exportToWord() {
    const content = quill.root.innerHTML;
    const blob = new Blob([
        `<!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <style>
                body { font-family: Arial, sans-serif; }
                table { border-collapse: collapse; width: 100%; }
                th, td { border: 1px solid black; padding: 8px; }
            </style>
        </head>
        <body>${content}</body>
        </html>`
    ], { type: 'application/msword' });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Karbon_Raporu_' + new Date().getTime() + '.doc';
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}