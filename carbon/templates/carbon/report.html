<!-- templates/carbon/report.html - TAM VE DÜZELTİLMİŞ VERSİYON -->
{% extends 'base.html' %}
{% load static %}
{% block body_class %}report-bg{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/backgrounds.css' %}">
{% endblock %}

{% block title %}Karbon Rapor Yönetimi{% endblock %}

{% block styles %}
{{ block.super }}
<!-- Quill Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    /* PicoCSS Override ve Özel Stiller */
    .report-page {
        background: white !important;
        color: #333 !important;
        padding: 20px;
        border-radius: 10px;
    }
    
    .report-page select,
    .report-page input {
        background: white !important;
        color: #333 !important;
        border: 1px solid #ccc !important;
    }
    
    .control-panel {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        padding: 25px !important;
        border-radius: 15px !important;
        margin-bottom: 30px !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
    }
    
    .control-panel label {
        color: white !important;
        font-weight: 500 !important;
        margin-bottom: 5px !important;
        display: block !important;
    }
    
    .control-grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
        gap: 1rem !important;
        align-items: end !important;
    }
    
    .btn-generate {
        background: white !important;
        color: #667eea !important;
        border: none !important;
        padding: 12px 30px !important;
        border-radius: 8px !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: all 0.3s !important;
        margin-bottom: 0 !important;
    }
    
    .btn-generate:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2) !important;
    }
    
    .report-tabs {
        display: flex !important;
        gap: 10px !important;
        margin-bottom: 20px !important;
        border-bottom: 2px solid #e0e0e0 !important;
        background: transparent !important;
    }
    
    .report-tabs button {
        padding: 12px 24px !important;
        background: transparent !important;
        border: none !important;
        color: #666 !important;
        font-weight: 500 !important;
        cursor: pointer !important;
        position: relative !important;
        margin-bottom: 0 !important;
    }
    
    .report-tabs button.active {
        color: #667eea !important;
    }
    
    .report-tabs button.active::after {
        content: '' !important;
        position: absolute !important;
        bottom: -2px !important;
        left: 0 !important;
        right: 0 !important;
        height: 3px !important;
        background: #667eea !important;
    }
    
    .tab-content {
        display: none !important;
        background: white !important;
        padding: 20px !important;
        border-radius: 10px !important;
    }
    
    .tab-content.active {
        display: block !important;
    }
    
    .summary-cards {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
        gap: 20px !important;
        margin-bottom: 30px !important;
    }
    
    .summary-card {
        background: white !important;
        padding: 20px !important;
        border-radius: 12px !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08) !important;
        border: 1px solid #e0e0e0 !important;
        transition: transform 0.3s !important;
    }
    
    .summary-card:hover {
        transform: translateY(-5px) !important;
        box-shadow: 0 5px 20px rgba(0,0,0,0.12) !important;
    }
    
    .summary-card h4 {
        color: #666 !important;
        font-size: 14px !important;
        margin-bottom: 10px !important;
        font-weight: normal !important;
    }
    
    .summary-card .value {
        font-size: 28px !important;
        font-weight: bold !important;
        color: #333 !important;
        margin: 10px 0 !important;
    }
    
    .summary-card .unit {
        color: #999 !important;
        font-size: 14px !important;
    }
    
    .editor-container {
        background: white !important;
        border-radius: 12px !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08) !important;
        overflow: hidden !important;
        margin-top: 20px !important;
    }
    
    .editor-toolbar {
        background: #f8f9fa !important;
        padding: 15px !important;
        border-bottom: 1px solid #e0e0e0 !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
    }
    
    .editor-content {
        min-height: 500px !important;
        padding: 30px !important;
        background: white !important;
        color: #333 !important;
    }
    
    .export-buttons {
        display: flex !important;
        gap: 10px !important;
    }
    
    .btn-export {
        padding: 8px 20px !important;
        border: none !important;
        border-radius: 6px !important;
        font-weight: 500 !important;
        cursor: pointer !important;
        transition: all 0.3s !important;
        margin: 0 !important;
        color: white !important;
    }
    
    .btn-pdf { background: #dc3545 !important; }
    .btn-word { background: #0066cc !important; }
    .btn-excel { background: #28a745 !important; }
    
    .ql-toolbar {
        background: #f8f9fa !important;
        border: none !important;
        border-bottom: 1px solid #e0e0e0 !important;
    }
    
    .ql-container {
        border: none !important;
        background: white !important;
        color: #333 !important;
        min-height: 400px !important;
    }
    
    .ql-editor {
        background: white !important;
        color: #333 !important;
        min-height: 400px !important;
    }
    
    #loading {
        display: none;
        text-align: center;
        padding: 50px;
        background: white;
        border-radius: 10px;
        margin-top: 20px;
    }
    
    #loading.active {
        display: block !important;
    }
    
    .chart-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 30px !important;
        margin-top: 30px !important;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .data-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #dee2e6;
    }
    
    .data-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
    }
    
    @media (max-width: 768px) {
        .chart-grid { grid-template-columns: 1fr !important; }
        .control-grid { grid-template-columns: 1fr !important; }
        .summary-cards { grid-template-columns: 1fr !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="report-page">
    <h1><i class="fas fa-chart-line"></i> Karbon Emisyon Rapor Yönetimi</h1>
    
    <!-- Control Panel -->
    <article class="control-panel">
        <div class="control-grid">
            <div>
                <label>Firma Seçimi</label>
                <select id="firm-select">
                    <option value="">Firma Seçiniz</option>
                    {% for firm in firms %}
                    <option value="{{ firm.id }}">{{ firm.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label>Başlangıç Tarihi</label>
                <input type="date" id="start-date">
            </div>
            
            <div>
                <label>Bitiş Tarihi</label>
                <input type="date" id="end-date">
            </div>
            
            <div>
                <label>Rapor Tipi</label>
                <select id="report-type">
                    <option value="detailed">Detaylı Rapor</option>
                    <option value="summary">Özet Rapor</option>
                    <option value="executive">Yönetici Özeti</option>
                    <option value="custom">Özelleştirilmiş Rapor</option>
                </select>
            </div>
            
            <div>
                <button id="generate-report" class="btn-generate">
                    <i class="fas fa-magic"></i> Rapor Oluştur
                </button>
            </div>
        </div>
    </article>
    
    <!-- Tab System -->
    <nav class="report-tabs">
        <button class="active" data-tab="preview">
            <i class="fas fa-eye"></i> Önizleme
        </button>
        <button data-tab="editor">
            <i class="fas fa-edit"></i> Düzenle
        </button>
        <button data-tab="charts">
            <i class="fas fa-chart-pie"></i> Grafikler
        </button>
        <button data-tab="data">
            <i class="fas fa-table"></i> Veri Tabloları
        </button>
    </nav>
    
    <!-- Tab Contents -->
    <div id="tab-preview" class="tab-content active">
        <!-- Summary Cards -->
        <div class="summary-cards">
            <article class="summary-card">
                <h4>Kapsam 1</h4>
                <div class="value" id="scope1-value">0</div>
                <div class="unit">tCO₂e</div>
            </article>
            <article class="summary-card">
                <h4>Kapsam 2</h4>
                <div class="value" id="scope2-value">0</div>
                <div class="unit">tCO₂e</div>
            </article>
            <article class="summary-card">
                <h4>Kapsam 3</h4>
                <div class="value" id="scope3-value">0</div>
                <div class="unit">tCO₂e</div>
            </article>
            <article class="summary-card">
                <h4>Toplam Emisyon</h4>
                <div class="value" id="total-value">0</div>
                <div class="unit">tCO₂e</div>
            </article>
        </div>
        
        <!-- Preview Content -->
        <article class="editor-container">
            <div class="editor-toolbar">
                <h3>Rapor Önizleme</h3>
                <div class="export-buttons">
                    <button class="btn-export btn-pdf" onclick="exportPDF()">
                        <i class="fas fa-file-pdf"></i> PDF İndir
                    </button>
                    <button class="btn-export btn-word" onclick="exportWord()">
                        <i class="fas fa-file-word"></i> Word İndir
                    </button>
                    <button class="btn-export btn-excel" onclick="exportExcel()">
                        <i class="fas fa-file-excel"></i> Excel İndir
                    </button>
                </div>
            </div>
            <div id="preview-content" class="editor-content">
                <p style="color: #999; text-align: center; padding: 50px;">
                    Rapor oluşturmak için yukarıdaki formu doldurun ve "Rapor Oluştur" butonuna tıklayın.
                </p>
            </div>
        </article>
    </div>
    
    <div id="tab-editor" class="tab-content">
        <article class="editor-container">
            <div class="editor-toolbar">
                <h3>Rapor Düzenleyici</h3>
                <div class="export-buttons">
                    <button class="btn-export btn-pdf" onclick="saveEditorContent()">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </div>
            <!-- Quill Editor -->
            <div id="quill-toolbar">
                <select class="ql-header">
                    <option selected>Normal</option>
                    <option value="1">Başlık 1</option>
                    <option value="2">Başlık 2</option>
                    <option value="3">Başlık 3</option>
                </select>
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
                <button class="ql-clean"></button>
            </div>
            <div id="quill-editor"></div>
        </article>
    </div>
    
    <div id="tab-charts" class="tab-content">
        <article class="editor-container">
            <div class="editor-content">
                <h3>Emisyon Dağılım Grafikleri</h3>
                <div class="chart-grid">
                    <div>
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div>
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
        </article>
    </div>
    
    <div id="tab-data" class="tab-content">
        <article class="editor-container">
            <div class="editor-content">
                <h3>Detaylı Veri Tabloları</h3>
                <div id="data-tables-container">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
            </div>
        </article>
    </div>
    
    <!-- Loading -->
    <div id="loading">
        <div class="spinner"></div>
        <p>Rapor oluşturuluyor...</p>
    </div>
</div>

<!-- Quill Editor JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
// Global değişkenler
let quillEditor = null;
let reportData = null;
let pieChartInstance = null;
let barChartInstance = null;

const unitMapping = {
    '1.1': { // Sabit Yanma
        consumption: 'm³',
        fuel_name: '',
        default: 'm³'
    },
    '1.2': { // Mobil Yanma
        consumption: 'litre',  // ✅ DÜZELTİLDİ
        fuel_name: '',
        default: 'litre'
    },
    '1.3': { // Proses Emisyonları
        amount: 'kg',
        process_name: '',
        material: '',
        default: 'kg'
    },
    '1.4': { // Kaçak Emisyonlar - ✅ DÜZELTİLDİ
        gas_capacity: 'kg',
        quantity: 'adet',
        leak_rate: '%',
        gwp: 'GWP',
        default: 'adet'  // Ana birim adet
    },
    '1.5': { // AFOLU
        area: 'm²',
        land_type: '',
        default: 'm²'
    },
    '2.1': { // Elektrik Tüketimi
        consumption: 'kWh',
        facility_name: '',
        default: 'kWh'
    },
    '2.2': { // Isı/Buhar
        consumption: 'kWh',
        default: 'kWh'
    },
    '3.1': { // Satın Alınan Mal Taşımacılığı
        consumption: 'litre',
        name: '',
        default: 'litre'
    },
    '3.2': { // Satılan Mal Taşımacılığı
        consumption: 'litre',
        name: '',
        default: 'litre'
    },
    '3.3': { // Kiralanan Varlıklar
        consumption: 'litre',
        name: '',
        default: 'litre'
    },
    '3.4': { // İşe Gidiş Geliş
        consumption: 'litre',
        name: '',
        default: 'litre'
    },
    '3.5': { // İş Seyahatleri - ✅ DÜZELTİLDİ
        consumption_flight: 'km',
        consumption_hotel: 'gece',
        consumption_vehicle: 'km',
        consumption: 'birim',
        name: '',
        default: 'birim'
    },
    '4.1': { // Satın Alınan Mal ve Hizmetler
        amount: 'kg',
        name: '',
        material_type: '',
        default: 'kg'
    },
    '4.2': { // Sermaye Malları
        amount: 'kg',
        name: '',
        default: 'kg'
    },
    '4.3': { // Kullanılan Hizmetler - ✅ DÜZELTİLDİ
        consumption: {
            'water': 'm³',
            'wastewater': 'm³',
            'solid_waste': 'ton',
            'electricity_loss': 'MWh',  // MWh olarak güncellendi
            'service': 'TL',
            'default': 'birim'
        },
        name: '',
        service_type: '',
        default: 'birim'
    }
};

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    initQuillEditor();
    initTabSystem();
    
    document.getElementById('generate-report').addEventListener('click', generateReport);
    
    // Bugünün tarihini varsayılan olarak ayarla
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('end-date').value = today;
    
    // 1 yıl öncesini başlangıç tarihi yap
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
    document.getElementById('start-date').value = oneYearAgo.toISOString().split('T')[0];
});

// Quill Editor Başlatma
function initQuillEditor() {
    quillEditor = new Quill('#quill-editor', {
        theme: 'snow',
        modules: {
            toolbar: '#quill-toolbar'
        },
        placeholder: 'Rapor içeriğinizi buradan düzenleyebilirsiniz...'
    });
}

// Tab Sistemi
function initTabSystem() {
    const tabButtons = document.querySelectorAll('.report-tabs button');
    
    tabButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            // Aktif tab'ı kaldır
            document.querySelectorAll('.report-tabs button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Yeni tab'ı aktif et
            this.classList.add('active');
            const tabId = 'tab-' + this.dataset.tab;
            document.getElementById(tabId).classList.add('active');
            
            // Grafikleri yenile (eğer grafik tab'ı açıldıysa)
            if (this.dataset.tab === 'charts' && reportData) {
                updateCharts();
            }
        });
    });
}

// Rapor Oluşturma
function generateReport() {
    const firmId = document.getElementById('firm-select').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const reportType = document.getElementById('report-type').value;
    
    if (!firmId) {
        alert('Lütfen bir firma seçiniz!');
        return;
    }
    
    if (!startDate || !endDate) {
        alert('Lütfen tarih aralığı seçiniz!');
        return;
    }
    
    // Loading göster
    document.getElementById('loading').classList.add('active');
    
    // API çağrısı
    fetch(`/carbon/api/report-data/?firm=${firmId}&start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            reportData = data;
            
            // Summary kartları güncelle
            updateSummaryCards(data);
            
            // Rapor içeriği oluştur
            const reportContent = createReportContent(data, reportType);
            
            // Preview'ı güncelle
            document.getElementById('preview-content').innerHTML = reportContent;
            
            // Editor'ı güncelle
            quillEditor.root.innerHTML = reportContent;
            
            // Veri tablolarını güncelle
            updateDataTables(data);
            
            // Loading'i gizle
            document.getElementById('loading').classList.remove('active');
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Rapor oluşturulurken bir hata oluştu!');
            document.getElementById('loading').classList.remove('active');
        });
}

// Özet kartları güncelleme - hassas gösterim
function updateSummaryCards(data) {
    const scope1 = data.scope_totals?.scope_1 || 0;
    const scope2 = data.scope_totals?.scope_2 || 0;
    const scope3 = data.scope_totals?.scope_3 || 0;
    const scope4 = data.scope_totals?.scope_4 || 0;
    const total = scope1 + scope2 + scope3 + scope4;
    
    // Özet kartlar için uygun formatlama
    document.getElementById('scope1-value').textContent = formatEmissionValue(scope1);
    document.getElementById('scope2-value').textContent = formatEmissionValue(scope2);
    document.getElementById('scope3-value').textContent = formatEmissionValue(scope3);
    document.getElementById('total-value').textContent = formatEmissionValue(total);
    
    // Tooltip olarak tam değeri ekle
    document.getElementById('scope1-value').title = `Tam değer: ${scope1.toFixed(8)} tCO₂e`;
    document.getElementById('scope2-value').title = `Tam değer: ${scope2.toFixed(8)} tCO₂e`;
    document.getElementById('scope3-value').title = `Tam değer: ${scope3.toFixed(8)} tCO₂e`;
    document.getElementById('total-value').title = `Tam değer: ${total.toFixed(8)} tCO₂e`;
}

// PYTHON TARAFI İÇİN ÖZEL NOT
// Python tarafında da yuvarlama yapılmamalı!
/*
Python kodu için öneriler:

1. Hesaplamalarda Decimal kullanın:
from decimal import Decimal, ROUND_HALF_UP

co2e_value = Decimal(str(calculated_value))
# Yuvarlamayı sadece gösterimde yapın, saklamada yapmayın

2. JSON'a gönderirken:
'co2e': float(co2e_value)  # Tam değeri gönder

3. Veritabanında:
co2e_total = models.DecimalField(max_digits=20, decimal_places=10)  # Daha fazla hassasiyet
*/

// Rapor İçeriği Oluştur
function createReportContent(data, reportType) {
    const firmName = document.getElementById('firm-select').options[document.getElementById('firm-select').selectedIndex].text;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    const scope1 = data.scope_totals?.scope_1 || 0;
    const scope2 = data.scope_totals?.scope_2 || 0;
    const scope3 = data.scope_totals?.scope_3 || 0;
    const scope4 = data.scope_totals?.scope_4 || 0;
    const total = scope1 + scope2 + scope3 + scope4;
    
    let content = '';
    
    if (reportType === 'executive') {
        // Yönetici Özeti
        content = `
            <h1 style="text-align: center; color: #333;">YÖNETİCİ ÖZETİ</h1>
            <h2 style="text-align: center; color: #666;">${firmName}</h2>
            <p style="text-align: center; color: #999;">Rapor Dönemi: ${startDate} - ${endDate}</p>
            
            <div style="margin: 40px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3 style="color: #333;">Toplam Karbon Emisyonu</h3>
                <p style="font-size: 36px; font-weight: bold; color: #667eea; margin: 10px 0;">
                    ${total.toFixed(2)} tCO₂e
                </p>
            </div>
            
            <h3>Ana Bulgular</h3>
            <ul>
                <li>En yüksek emisyon kaynağı: ${getHighestScope(data)}</li>
                <li>Toplam emisyonun %${((scope1/total)*100).toFixed(1)}'i doğrudan emisyonlardan kaynaklanmaktadır</li>
                <li>Enerji tüketimi kaynaklı emisyonlar toplam emisyonun %${((scope2/total)*100).toFixed(1)}'ini oluşturmaktadır</li>
            </ul>
            
            <h3>Öneriler</h3>
            <ul>
                <li>Enerji verimliliği projelerinin önceliklendirilmesi</li>
                <li>Yenilenebilir enerji kaynaklarına geçiş planının hazırlanması</li>
                <li>Tedarik zinciri emisyonlarının azaltılması için işbirliği programları</li>
            </ul>
        `;
    } else if (reportType === 'summary') {
        // Özet Rapor
        content = `
            <h1 style="text-align: center;">KARBON EMİSYON ÖZET RAPORU</h1>
            <h2 style="text-align: center; color: #666;">${firmName}</h2>
            <p style="text-align: center;">Dönem: ${startDate} - ${endDate}</p>
            
            <table class="data-table" style="margin: 30px 0; width: 100%;">
                <tr>
                    <th>Kapsam</th>
                    <th>Emisyon (tCO₂e)</th>
                    <th>Oran (%)</th>
                </tr>
                <tr>
                    <td>Kapsam 1 - Doğrudan Emisyonlar</td>
                    <td>${scope1.toFixed(2)}</td>
                    <td>${total > 0 ? ((scope1/total)*100).toFixed(1) : '0'}%</td>
                </tr>
                <tr>
                    <td>Kapsam 2 - Enerji Kaynaklı</td>
                    <td>${scope2.toFixed(2)}</td>
                    <td>${total > 0 ? ((scope2/total)*100).toFixed(1) : '0'}%</td>
                </tr>
                <tr>
                    <td>Kapsam 3 - Diğer Dolaylı</td>
                    <td>${scope3.toFixed(2)}</td>
                    <td>${total > 0 ? ((scope3/total)*100).toFixed(1) : '0'}%</td>
                </tr>
                <tr>
                    <td>Kapsam 4 - Tedarik Zinciri</td>
                    <td>${scope4.toFixed(2)}</td>
                    <td>${total > 0 ? ((scope4/total)*100).toFixed(1) : '0'}%</td>
                </tr>
                <tr style="background: #f8f9fa; font-weight: bold;">
                    <td>TOPLAM</td>
                    <td>${total.toFixed(2)}</td>
                    <td>100%</td>
                </tr>
            </table>
        `;
    } else {
        // Detaylı Rapor (default)
        content = `
            <h1 style="text-align: center;">KARBON AYAK İZİ DETAYLI RAPORU</h1>
            <h2 style="text-align: center; color: #666;">${firmName}</h2>
            <p style="text-align: center;">Rapor Dönemi: ${startDate} - ${endDate}</p>
            
            <h2>1. YÖNETİCİ ÖZETİ</h2>
            <p>Bu rapor, ${firmName} firmasının ${startDate} ile ${endDate} tarihleri arasındaki karbon ayak izi hesaplamalarını içermektedir. 
            Toplam karbon emisyonu <strong>${total.toFixed(2)} tCO₂e</strong> olarak hesaplanmıştır.</p>
            
            <h2>2. KAPSAM BAZLI ANALİZ</h2>
            
            <h3>2.1. Kapsam 1 - Doğrudan Emisyonlar</h3>
            <p>Doğrudan emisyonlar, firmanın sahip olduğu veya kontrol ettiği kaynaklardan ortaya çıkan emisyonlardır.</p>
            <ul>
                <li>Toplam Kapsam 1 Emisyonu: <strong>${scope1.toFixed(2)} tCO₂e</strong></li>
                <li>Toplam emisyon içindeki payı: <strong>${total > 0 ? ((scope1/total)*100).toFixed(1) : '0'}%</strong></li>
            </ul>
            
            <h3>2.2. Kapsam 2 - Enerji Kaynaklı Dolaylı Emisyonlar</h3>
            <p>Satın alınan elektrik, buhar, ısıtma ve soğutmadan kaynaklanan emisyonlardır.</p>
            <ul>
                <li>Toplam Kapsam 2 Emisyonu: <strong>${scope2.toFixed(2)} tCO₂e</strong></li>
                <li>Toplam emisyon içindeki payı: <strong>${total > 0 ? ((scope2/total)*100).toFixed(1) : '0'}%</strong></li>
            </ul>
            
            <h3>2.3. Kapsam 3 - Diğer Dolaylı Emisyonlar</h3>
            <p>Değer zincirinde oluşan diğer dolaylı emisyonlardır.</p>
            <ul>
                <li>Toplam Kapsam 3 Emisyonu: <strong>${scope3.toFixed(2)} tCO₂e</strong></li>
                <li>Toplam emisyon içindeki payı: <strong>${total > 0 ? ((scope3/total)*100).toFixed(1) : '0'}%</strong></li>
            </ul>
            
            <h3>2.4. Kapsam 4 - Tedarik Zinciri Emisyonları</h3>
            <p>Tedarik zinciri boyunca oluşan emisyonlardır.</p>
            <ul>
                <li>Toplam Kapsam 4 Emisyonu: <strong>${scope4.toFixed(2)} tCO₂e</strong></li>
                <li>Toplam emisyon içindeki payı: <strong>${total > 0 ? ((scope4/total)*100).toFixed(1) : '0'}%</strong></li>
            </ul>
            
            <h2>3. AZALTIM ÖNERİLERİ</h2>
            <ol>
                <li><strong>Enerji Verimliliği:</strong> LED aydınlatmaya geçiş, enerji verimli ekipman kullanımı</li>
                <li><strong>Yenilenebilir Enerji:</strong> Güneş paneli kurulumu, yeşil enerji tedarikçilerine geçiş</li>
                <li><strong>Ulaşım:</strong> Elektrikli araç filosuna geçiş, toplu taşıma teşvikleri</li>
                <li><strong>Tedarik Zinciri:</strong> Yerel tedarikçilerle çalışma, karbon ayak izi düşük ürünler</li>
            </ol>
            
            <h2>4. SONUÇ</h2>
            <p>Firmanızın toplam karbon emisyonu <strong>${total.toFixed(2)} tCO₂e</strong> olarak hesaplanmıştır. 
            Yukarıda belirtilen azaltım önerilerinin uygulanması ile bu emisyonun önemli ölçüde azaltılması mümkündür.</p>
        `;
    }
    
    return content;
}

// En yüksek emisyon kaynağını bul - EKSİK FONKSİYON EKLENDİ
function getHighestScope(data) {
    const scopes = {
        'Kapsam 1': data.scope_totals?.scope_1 || 0,
        'Kapsam 2': data.scope_totals?.scope_2 || 0,
        'Kapsam 3': data.scope_totals?.scope_3 || 0,
        'Kapsam 4': data.scope_totals?.scope_4 || 0
    };
    
    let highest = '';
    let highestValue = 0;
    
    for (const [key, value] of Object.entries(scopes)) {
        if (value > highestValue) {
            highest = key;
            highestValue = value;
        }
    }
    
    return highest || 'Belirlenemedi';
}

// Grafikleri Güncelle
function updateCharts() {
    const scope1 = reportData.scope_totals?.scope_1 || 0;
    const scope2 = reportData.scope_totals?.scope_2 || 0;
    const scope3 = reportData.scope_totals?.scope_3 || 0;
    const scope4 = reportData.scope_totals?.scope_4 || 0;
    
    // Pie Chart
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    if (pieChartInstance) {
        pieChartInstance.destroy();
    }
    
    pieChartInstance = new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: ['Kapsam 1', 'Kapsam 2', 'Kapsam 3', 'Kapsam 4'],
            datasets: [{
                data: [scope1, scope2, scope3, scope4],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                title: {
                    display: true,
                    text: 'Emisyon Dağılımı (tCO₂e)'
                }
            }
        }
    });
    
    // Bar Chart
    const barCtx = document.getElementById('barChart').getContext('2d');
    if (barChartInstance) {
        barChartInstance.destroy();
    }
    
    barChartInstance = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: ['Kapsam 1', 'Kapsam 2', 'Kapsam 3', 'Kapsam 4'],
            datasets: [{
                label: 'Emisyon (tCO₂e)',
                data: [scope1, scope2, scope3, scope4],
                backgroundColor: '#667eea'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Kapsam Bazlı Emisyon Karşılaştırması'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(2) + ' tCO₂e';
                        }
                    }
                }
            }
        }
    });
}

// Değeri ve birimi formatla
function formatValueWithUnit(data, subscope) {
    const units = unitMapping[subscope] || {};
    
    // Ana değeri bul - öncelik sırasıyla kontrol et
    let value = null;
    let unit = '';
    let displayText = '';
    
    // En yaygın alanları kontrol et
    if (data.consumption !== undefined && data.consumption !== null) {
        value = data.consumption;
        
        // Kapsam 3.5 özel durumu - seyahat türüne göre birim
        if (subscope === '3.5' && data.travel_type) {
            unit = units[`consumption_${data.travel_type}`] || units.consumption || units.default;
        }
        // Kapsam 4.3 özel durumu - hizmet türüne göre birim
        else if (subscope === '4.3' && data.service_type && typeof units.consumption === 'object') {
            unit = units.consumption[data.service_type] || units.consumption.default;
        }
        else {
            unit = units.consumption || units.default;
        }
    }
    else if (data.amount !== undefined && data.amount !== null) {
        value = data.amount;
        unit = units.amount || units.default;
    }
    else if (data.area !== undefined && data.area !== null) {
        value = data.area;
        unit = units.area || units.default;
    }
    else if (data.distance !== undefined && data.distance !== null) {
        value = data.distance;
        unit = units.distance || units.default;
    }
    // Kapsam 1.4 özel durumu - birden fazla değer göster
    else if (subscope === '1.4') {
        // Ana değer olarak adet × kapasite hesapla
        if (data.quantity && data.gas_capacity) {
            const totalCapacity = parseFloat(data.quantity) * parseFloat(data.gas_capacity);
            value = totalCapacity;
            unit = 'kg (toplam)';
            
            // Detaylı açıklama için ek bilgi
            const parts = [];
            parts.push(`${data.quantity} adet × ${data.gas_capacity} kg`);
            if (data.leak_rate) parts.push(`Kaçak: %${data.leak_rate}`);
            if (data.gwp) parts.push(`GWP: ${data.gwp}`);
            
            // Alternatif gösterim için yorum satırı olarak bırakıyorum
            // displayText = parts.join(', ');
            // return { value: displayText, unit: '-' };
        } else {
            // Sadece adet varsa
            value = data.quantity || data.gas_capacity || '-';
            unit = data.quantity ? 'adet' : 'kg';
        }
    }
    
    // Değer yoksa
    if (value === null || value === undefined || value === '') {
        return { value: '-', unit: '-' };
    }
    
    // Sayısal değerleri formatla
    if (!isNaN(value)) {
        const numValue = parseFloat(value);
        // Büyük sayılar için binlik ayracı ekle
        displayText = numValue.toLocaleString('tr-TR', { maximumFractionDigits: 2 });
    } else {
        displayText = value;
    }
    
    return { value: displayText, unit: unit || '-' };
}

// Geliştirilmiş sayı formatlama fonksiyonu
function formatEmissionValue(value) {
    if (value === null || value === undefined || isNaN(value)) {
        return '0.0000';
    }
    
    const numValue = parseFloat(value);
    
    // Çok küçük değerler için özel işlem
    if (numValue === 0) {
        return '0.0000';
    }
    
    // 0.001'den küçük değerler için bilimsel gösterim veya daha fazla basamak
    if (numValue > 0 && numValue < 0.001) {
        // Seçenek 1: 6 ondalık basamak
        return numValue.toFixed(6);
        
        // Seçenek 2: Bilimsel gösterim (alternatif)
        // return numValue.toExponential(3);
    }
    
    // 0.001 - 0.01 arası için 4 basamak
    if (numValue < 0.01) {
        return numValue.toFixed(4);
    }
    
    // 0.01 - 1 arası için 3 basamak
    if (numValue < 1) {
        return numValue.toFixed(3);
    }
    
    // Büyük sayılar için binlik ayraç ile 3 basamak
    return numValue.toLocaleString('tr-TR', { 
        minimumFractionDigits: 3, 
        maximumFractionDigits: 3
    });
}

// Veri Tablolarını Güncelle fonksiyonunda kullanım
function updateDataTables(data) {
    const container = document.getElementById('data-tables-container');
    let html = '';
    
    // Toplam ve detay hesaplamaları için daha hassas yaklaşım
    let grandTotal = 0;
    const scopeTotalsDetailed = {};
    
    for (const [scope, scopeData] of Object.entries(data.scope_details || {})) {
        const scopeNumber = scope.replace('scope_', '');
        let scopeSubtotal = 0;
        
        html += `<h4 class="mt-4 mb-2">Kapsam ${scopeNumber} Detayları</h4>`;
        html += '<table class="data-table">';
        html += '<thead><tr>';
        html += '<th>Alt Kapsam</th>';
        html += '<th>Tarih</th>';
        html += '<th>Açıklama</th>';
        html += '<th>Değer</th>';
        html += '<th>Birim</th>';
        html += '<th>Emisyon (tCO₂e)</th>';
        html += '</tr></thead>';
        html += '<tbody>';
        
        for (const [subscope, subscopeData] of Object.entries(scopeData)) {
            subscopeData.items?.forEach(item => {
                // Değer ve birimi al
                const formatted = formatValueWithUnit(item.data, subscope);

                // Açıklama metni
                let description = subscopeData.name || subscope;
/*
                // Kapsam 1.4 için özel işlem - Kaçak Emisyonlar
                if (subscope === '1.4') {
                    const deviceName = item.data?.device_name || '';
                    const gasName = item.data?.gas_name || '';
                    
                    if (deviceName && gasName) {
                        description += ` - ${deviceName} (${gasName})`;
                    } else if (deviceName) {
                        description += ` - ${deviceName}`;
                    } else if (gasName) {
                        description += ` - ${gasName}`;
                    }
                } 

                // Özel durumlar için ekleme yap
                else*/ if (subscope === '4.1' || subscope === '4.2' || subscope === '4.3') {
                    // Kapsam 4 için coefficient_set'i göster
                    if (item.data?.coefficient_set) {
                        description += ` - ${item.data.coefficient_set}`;
                    } else if (item.data?.name) {
                        description += ` - ${item.data.name}`;
                    }
                } else {
                    // Diğer kapsamlar için mevcut mantık
                    if (item.data?.fuel_name) description += ` - ${item.data.fuel_name}`;
                    else if (item.data?.facility_name) description += ` - ${item.data.facility_name}`;
                    else if (item.data?.device_name) description += ` - ${item.data.device_name}`;
                    else if (item.data?.name) description += ` - ${item.data.name}`;
                }

                // Emisyon değerini hassas hesapla
                const emissionValue = parseFloat(item.co2e) || 0;
                scopeSubtotal += emissionValue;

                // Emisyon gösterimi - küçük değerler için özel formatlama
                let emissionDisplay = formatEmissionValue(emissionValue);

                // Çok küçük değer uyarısı
                if (emissionValue > 0 && emissionValue < 0.001) {
                    emissionDisplay = `<span style="color: #ff6b6b;" title="Çok küçük değer: ${emissionValue.toFixed(8)} tCO₂e">
                        ${emissionDisplay} *
                    </span>`;
                }

                html += '<tr>';
                html += `<td>${subscope} ${description}</td>`;
                html += `<td>${item.date || '-'}</td>`;
                html += `<td>${item.data?.coefficient_set || '-'}</td>`;
                html += `<td style="text-align: right;">${formatted.value}</td>`;
                html += `<td>${formatted.unit}</td>`;
                html += `<td style="text-align: right; font-weight: bold; color: #667eea;">${emissionDisplay}</td>`;
                html += '</tr>';
            });
        }
        
        // Alt toplam satırı - hassas toplam
        scopeTotalsDetailed[scope] = scopeSubtotal;
        grandTotal += scopeSubtotal;
        
        html += '<tr style="background: #f8f9fa; font-weight: bold;">';
        html += `<td colspan="5">Kapsam ${scopeNumber} Toplamı</td>`;
        html += `<td style="text-align: right; color: #667eea;">
            ${formatEmissionValue(scopeSubtotal)}
        </td>`;
        html += '</tr>';
        
        html += '</tbody></table>';
    }
    
    // Genel toplam - tam hassasiyetle
    if (grandTotal > 0) {
        html += `
            <div class="mt-4 p-3" style="background: #667eea; color: white; border-radius: 8px;">
                <h5 class="mb-2">TOPLAM EMİSYON: ${formatEmissionValue(grandTotal)} tCO₂e</h5>
                <small>* işaretli değerler 0.001 tCO₂e'den küçüktür</small>
            </div>
        `;
    }
    
    if (html === '') {
        html = '<p style="text-align: center; color: #999; padding: 40px;">Veri bulunamadı</p>';
    }
    
    container.innerHTML = html;
    
    // Debug için konsola yaz
    console.log('Detaylı Emisyon Toplamları:', scopeTotalsDetailed);
    console.log('Genel Toplam:', grandTotal);
}

// Excel Export Fonksiyonu - GÜNCELLENDİ
function exportToExcel() {
    if (!reportData || !reportData.scope_details) {
        alert('Önce rapor oluşturmanız gerekiyor!');
        return;
    }
    
    // UTF-8 BOM ekle (Excel'de Türkçe karakterler için)
    let csvContent = '\ufeff';
    csvContent += 'Kapsam,Alt Kapsam,Tarih,Açıklama,Katsayı Seti,Değer,Birim,Emisyon (tCO₂e)\n';
    
    for (const [scope, scopeData] of Object.entries(reportData.scope_details)) {
        const scopeNumber = scope.replace('scope_', '');
        
        for (const [subscope, subscopeData] of Object.entries(scopeData)) {
            subscopeData.items?.forEach(item => {
                const formatted = formatValueWithUnit(item.data, subscope);
                
                // Açıklama oluştur
                let description = subscopeData.name || subscope;
                if (item.data?.fuel_name) description += ` - ${item.data.fuel_name}`;
                else if (item.data?.facility_name) description += ` - ${item.data.facility_name}`;
                else if (item.data?.device_name) description += ` - ${item.data.device_name}`;
                else if (item.data?.name) description += ` - ${item.data.name}`;
                
                // CSV satırı ekle
                csvContent += `"Kapsam ${scopeNumber}","${description}","${item.date || '-'}","${item.data?.coefficient_set || '-'}","${description}","${formatted.value}","${formatted.unit}","${item.co2e?.toFixed(2) || '0.00'}"\n`;
            });
        }
    }
    
    // Toplam satırı ekle
    const total = Object.values(reportData.scope_totals || {}).reduce((sum, val) => sum + val, 0);
    csvContent += `"","","","","TOPLAM","","","${total.toFixed(2)}"\n`;
    
    // CSV dosyasını indir
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    const date = new Date().toISOString().slice(0, 10);
    link.setAttribute('download', `karbon-raporu-${date}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Export Fonksiyonları
function exportPDF() {
    const content = document.getElementById('preview-content');
    
    if (typeof html2canvas === 'undefined' || typeof jspdf === 'undefined') {
        alert('PDF export kütüphaneleri yükleniyor, lütfen tekrar deneyin...');
        return;
    }
    
    html2canvas(content).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        pdf.save('karbon-raporu.pdf');
    }).catch(error => {
        console.error('PDF oluşturma hatası:', error);
        alert('PDF oluşturulurken hata oluştu!');
    });
}

function exportWord() {
    const content = quillEditor.root.innerHTML;
    const blob = new Blob([`
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <style>
                body { font-family: Arial, sans-serif; }
                table { border-collapse: collapse; width: 100%; }
                th, td { border: 1px solid black; padding: 8px; }
                h1 { color: #333; }
                h2 { color: #666; }
            </style>
        </head>
        <body>${content}</body>
        </html>
    `], { type: 'application/msword' });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'karbon-raporu.doc';
    a.click();
    URL.revokeObjectURL(url);
}

function exportExcel() {
    // Excel export için basit CSV oluştur
    let csv = 'Kapsam,Emisyon (tCO2e),Oran (%)\n';
    
    const scope1 = reportData?.scope_totals?.scope_1 || 0;
    const scope2 = reportData?.scope_totals?.scope_2 || 0;
    const scope3 = reportData?.scope_totals?.scope_3 || 0;
    const scope4 = reportData?.scope_totals?.scope_4 || 0;
    const total = scope1 + scope2 + scope3 + scope4;
    
    csv += `Kapsam 1,${scope1.toFixed(2)},${total > 0 ? ((scope1/total)*100).toFixed(1) : '0'}\n`;
    csv += `Kapsam 2,${scope2.toFixed(2)},${total > 0 ? ((scope2/total)*100).toFixed(1) : '0'}\n`;
    csv += `Kapsam 3,${scope3.toFixed(2)},${total > 0 ? ((scope3/total)*100).toFixed(1) : '0'}\n`;
    csv += `Kapsam 4,${scope4.toFixed(2)},${total > 0 ? ((scope4/total)*100).toFixed(1) : '0'}\n`;
    csv += `TOPLAM,${total.toFixed(2)},100`;
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'karbon-raporu.csv';
    a.click();
    URL.revokeObjectURL(url);
}

function saveEditorContent() {
    const content = quillEditor.root.innerHTML;
    // Burada içeriği backend'e kaydedebilirsiniz
    alert('Rapor içeriği kaydedildi!');
    console.log('Kaydedilen içerik:', content);
}
</script>
{% endblock %}